import numpy
import numpy as np
import quaternion
from torch.utils.data import Dataset

from data_utils import CompiledSequence, load_cached_sequences


class GlobSpeedSequence(CompiledSequence):
    """
    Dataset :- RoNIN (can be downloaded from http://ronin.cs.sfu.ca/)
    Features :- raw angular rate and acceleration (includes gravity).
    """
    feature_dim = 6
    target_dim = 2
    aux_dim = 8

    def __init__(self, imu_sequence, **kwargs):
        super().__init__(**kwargs)
        self.ts, self.features, self.targets, self.orientations, self.gt_pos = None, None, None, None, None
        self.info = {}

        self.grv_only = kwargs.get('grv_only', False)
        self.max_ori_error = kwargs.get('max_ori_error', 20.0)
        self.w = kwargs.get('interval', 1)
        self.load(imu_sequence)

    def load(self, imu_sequence):

        ori = numpy.array([[ 6.94395724e-01,-7.81497264e-02, 7.14479104e-01, 3.50276652e-02],
                           [ 6.94394099e-01,-7.81601163e-02, 7.14473590e-01, 3.51344932e-02],
                         [ 6.94395814e-01,-7.81700696e-02, 7.14465745e-01, 3.52447655e-02],
                         [ 6.94402385e-01,-7.81691758e-02, 7.14454055e-01, 3.53544202e-02],
                         [ 6.94407587e-01,-7.81479029e-02, 7.14444745e-01, 3.54786582e-02],
                         [ 6.94414457e-01,-7.81266293e-02, 7.14433854e-01, 3.56116817e-02],
                         [ 6.94404797e-01,-7.81083038e-02, 7.14439493e-01, 3.57481498e-02],
                         [ 6.94378817e-01,-7.80958073e-02, 7.14458655e-01, 3.58848507e-02],
                         [ 6.94366684e-01,-7.80931243e-02, 7.14463752e-01, 3.60187379e-02],
                         [ 6.94356570e-01,-7.80939431e-02, 7.14467772e-01, 3.61392208e-02],
                         [ 6.94362638e-01,-7.80987410e-02, 7.14455674e-01, 3.62559895e-02],
                         [ 6.94366813e-01,-7.81123468e-02, 7.14445467e-01, 3.63430338e-02],
                         [ 6.94381377e-01,-7.81321699e-02, 7.14425830e-01, 3.64131360e-02],
                         [ 6.94394527e-01,-7.81657640e-02, 7.14406691e-01, 3.64584004e-02],
                         [ 6.94405657e-01,-7.82105960e-02, 7.14388562e-01, 3.64958456e-02],
                         [ 6.94410870e-01,-7.82655674e-02, 7.14376313e-01, 3.65359581e-02],
                         [ 6.94410021e-01,-7.83316210e-02, 7.14368167e-01, 3.65742060e-02],
                         [ 6.94395236e-01,-7.83713861e-02, 7.14374890e-01, 3.66192917e-02],
                         [ 6.94385106e-01,-7.84194918e-02, 7.14377968e-01, 3.66645236e-02],
                         [ 6.94364114e-01,-7.84707229e-02, 7.14389935e-01, 3.67027935e-02],
                         [ 6.94345005e-01,-7.85109888e-02, 7.14402996e-01, 3.67359907e-02],
                         [ 6.94329088e-01,-7.85351462e-02, 7.14413888e-01, 3.67822193e-02],
                         [ 6.94347271e-01,-7.85652306e-02, 7.14390679e-01, 3.68274712e-02],
                         [ 6.94374729e-01,-7.85880304e-02, 7.14358256e-01, 3.68747590e-02],
                         [ 6.94423139e-01,-7.85901627e-02, 7.14308841e-01, 3.69247727e-02],
                         [ 6.94479631e-01,-7.85981784e-02, 7.14251343e-01, 3.69628156e-02],
                         [ 6.94544635e-01,-7.86052758e-02, 7.14185335e-01, 3.69948886e-02],
                         [ 6.94630649e-01,-7.86138568e-02, 7.14098387e-01, 3.70241454e-02],
                         [ 6.94705030e-01,-7.86099181e-02, 7.14024970e-01, 3.70567607e-02],
                         [ 6.94779596e-01,-7.86087837e-02, 7.13950358e-01, 3.70997057e-02],
                         [ 6.94857588e-01,-7.86262301e-02, 7.13871259e-01, 3.71369476e-02],
                         [ 6.94928005e-01,-7.86517075e-02, 7.13797713e-01, 3.71744666e-02],
                         [ 6.94999310e-01,-7.87013092e-02, 7.13721199e-01, 3.72011546e-02],
                         [ 6.95070338e-01,-7.87730710e-02, 7.13642063e-01, 3.72361348e-02],
                         [ 6.95150462e-01,-7.88641806e-02, 7.13552820e-01, 3.72689466e-02],
                         [ 6.95226238e-01,-7.89509318e-02, 7.13466993e-01, 3.73101578e-02],
                         [ 6.95294999e-01,-7.90411491e-02, 7.13388098e-01, 3.73524374e-02],
                         [ 6.95367327e-01,-7.91282482e-02, 7.13304800e-01, 3.74068030e-02],
                         [ 6.95429474e-01,-7.92110286e-02, 7.13232602e-01, 3.74621789e-02],
                         [ 6.95499444e-01,-7.92885918e-02, 7.13152483e-01, 3.75177841e-02],
                         [ 6.95567018e-01,-7.93751951e-02, 7.13074161e-01, 3.75671394e-02],
                         [ 6.95645528e-01,-7.94435050e-02, 7.12987718e-01, 3.76182606e-02],
                         [ 6.95724370e-01,-7.94918274e-02, 7.12902066e-01, 3.76784821e-02],
                         [ 6.95798041e-01,-7.95163650e-02, 7.12823369e-01, 3.77532773e-02],
                         [ 6.95867009e-01,-7.95344937e-02, 7.12749869e-01, 3.78231444e-02],
                         [ 6.95939485e-01,-7.95354290e-02, 7.12676387e-01, 3.78902559e-02],
                         [ 6.96004889e-01,-7.95149248e-02, 7.12609978e-01, 3.79654348e-02],
                         [ 6.96061833e-01,-7.94908343e-02, 7.12552030e-01, 3.80600249e-02],
                         [ 6.96100449e-01,-7.94624078e-02, 7.12512264e-01, 3.81602493e-02],
                         [ 6.96117089e-01,-7.94458067e-02, 7.12493017e-01, 3.82573476e-02],
                         [ 6.96133168e-01,-7.94368396e-02, 7.12471063e-01, 3.83823704e-02],
                         [ 6.96158393e-01,-7.94222891e-02, 7.12440652e-01, 3.85171238e-02],
                         [ 6.96172812e-01,-7.94073416e-02, 7.12420202e-01, 3.86623771e-02],
                         [ 6.96182171e-01,-7.94036605e-02, 7.12404473e-01, 3.88047694e-02],
                         [ 6.96185800e-01,-7.94011254e-02, 7.12393152e-01, 3.89440913e-02],
                         [ 6.96205484e-01,-7.93964599e-02, 7.12367437e-01, 3.90776720e-02],
                         [ 6.96244448e-01,-7.93919625e-02, 7.12322628e-01, 3.92116732e-02],
                         [ 6.96299139e-01,-7.93761460e-02, 7.12263864e-01, 3.93292762e-02],
                         [ 6.96370841e-01,-7.93393738e-02, 7.12192162e-01, 3.94437504e-02],
                         [ 6.96453061e-01,-7.92929476e-02, 7.12110745e-01, 3.95458730e-02],
                         [ 6.96536029e-01,-7.92146792e-02, 7.12032415e-01, 3.96497914e-02],
                         [ 6.96610250e-01,-7.91180463e-02, 7.11965443e-01, 3.97534220e-02],
                         [ 6.96686566e-01,-7.89952771e-02, 7.11897384e-01, 3.98660748e-02],
                         [ 6.96756723e-01,-7.88774343e-02, 7.11835830e-01, 3.99826726e-02],
                         [ 6.96820402e-01,-7.87656359e-02, 7.11778961e-01, 4.01017615e-02],
                         [ 6.96889447e-01,-7.86611653e-02, 7.11715715e-01, 4.02222357e-02],
                         [ 6.96960102e-01,-7.85877937e-02, 7.11649611e-01, 4.03177833e-02],
                         [ 6.97025549e-01,-7.85381292e-02, 7.11586211e-01, 4.04034834e-02],
                         [ 6.97084308e-01,-7.85250118e-02, 7.11526446e-01, 4.04648483e-02],
                         [ 6.97154180e-01,-7.85275493e-02, 7.11455066e-01, 4.05140894e-02],
                         [ 6.97233562e-01,-7.85558400e-02, 7.11372410e-01, 4.05465739e-02],
                         [ 6.97312317e-01,-7.86070654e-02, 7.11288848e-01, 4.05558379e-02],
                         [ 6.97399361e-01,-7.86662433e-02, 7.11196106e-01, 4.05615355e-02],
                         [ 6.97488375e-01,-7.87062770e-02, 7.11105082e-01, 4.05616358e-02],
                         [ 6.97569963e-01,-7.87376721e-02, 7.11021761e-01, 4.05568880e-02],
                         [ 6.97647388e-01,-7.87544338e-02, 7.10943897e-01, 4.05540000e-02],
                         [ 6.97709379e-01,-7.87463689e-02, 7.10883486e-01, 4.05571714e-02],
                         [ 6.97743511e-01,-7.87220766e-02, 7.10852370e-01, 4.05658804e-02],
                         [ 6.97769674e-01,-7.86994166e-02, 7.10828924e-01, 4.05680000e-02],
                         [ 6.97788164e-01,-7.86864435e-02, 7.10812140e-01, 4.05725565e-02],
                         [ 6.97810195e-01,-7.86654967e-02, 7.10791424e-01, 4.05938123e-02],
                         [ 6.97842736e-01,-7.86391733e-02, 7.10760578e-01, 4.06208267e-02],
                         [ 6.97877408e-01,-7.86266155e-02, 7.10727231e-01, 4.06337038e-02],
                         [ 6.97918002e-01,-7.86142976e-02, 7.10687674e-01, 4.06587046e-02],
                         [ 6.97949591e-01,-7.86216135e-02, 7.10654091e-01, 4.06951700e-02],
                         [ 6.97967686e-01,-7.86380285e-02, 7.10631641e-01, 4.07444160e-02],
                         [ 6.97984137e-01,-7.86666133e-02, 7.10609145e-01, 4.08047109e-02],
                         [ 6.97998000e-01,-7.87094899e-02, 7.10586896e-01, 4.08650797e-02],
                         [ 6.97992398e-01,-7.87545075e-02, 7.10583452e-01, 4.09311603e-02],
                         [ 6.97979158e-01,-7.88097394e-02, 7.10586935e-01, 4.09941204e-02],
                         [ 6.97972198e-01,-7.88726274e-02, 7.10582838e-01, 4.10515110e-02],
                         [ 6.97967172e-01,-7.89322054e-02, 7.10577904e-01, 4.11114524e-02],
                         [ 6.97966596e-01,-7.89886505e-02, 7.10570068e-01, 4.11526059e-02],
                         [ 6.97971752e-01,-7.90438031e-02, 7.10556617e-01, 4.11822702e-02],
                         [ 6.97973381e-01,-7.91013399e-02, 7.10547952e-01, 4.12051457e-02],
                         [ 6.97969366e-01,-7.91626494e-02, 7.10544545e-01, 4.12203862e-02],
                         [ 6.97955738e-01,-7.92273085e-02, 7.10550131e-01, 4.12249138e-02],
                         [ 6.97932915e-01,-7.92877745e-02, 7.10564517e-01, 4.12421028e-02],
                         [ 6.97895728e-01,-7.93515027e-02, 7.10592256e-01, 4.12742640e-02],
                         [ 6.97855355e-01,-7.94124102e-02, 7.10622578e-01, 4.13157145e-02],
                         [ 6.97815049e-01,-7.94788993e-02, 7.10652009e-01, 4.13623636e-02],
                         [ 6.97778406e-01,-7.95471944e-02, 7.10677006e-01, 4.14158629e-02],
                         [ 6.97758244e-01,-7.96126723e-02, 7.10685690e-01, 4.14828277e-02],
                         [ 6.97740452e-01,-7.96983176e-02, 7.10690138e-01, 4.15442353e-02],
                         [ 6.97725108e-01,-7.97969626e-02, 7.10691271e-01, 4.15907650e-02],
                         [ 6.97720001e-01,-7.98861451e-02, 7.10683310e-01, 4.16460165e-02],
                         [ 6.97722215e-01,-7.99548030e-02, 7.10669357e-01, 4.17107892e-02],
                         [ 6.97721416e-01,-8.00227412e-02, 7.10659208e-01, 4.17622342e-02],
                         [ 6.97712921e-01,-8.00933801e-02, 7.10657454e-01, 4.17977690e-02],
                         [ 6.97700667e-01,-8.01524190e-02, 7.10661209e-01, 4.18367932e-02],
                         [ 6.97686902e-01,-8.01975881e-02, 7.10666854e-01, 4.18840303e-02],
                         [ 6.97673033e-01,-8.02241230e-02, 7.10674156e-01, 4.19340904e-02],
                         [ 6.97657840e-01,-8.02489504e-02, 7.10683791e-01, 4.19779009e-02],
                         [ 6.97641900e-01,-8.02671848e-02, 7.10694706e-01, 4.20220332e-02],
                         [ 6.97622318e-01,-8.02779048e-02, 7.10709746e-01, 4.20687544e-02],
                         [ 6.97604661e-01,-8.02863822e-02, 7.10723382e-01, 4.21174645e-02],
                         [ 6.97591067e-01,-8.02994167e-02, 7.10732461e-01, 4.21687111e-02],
                         [ 6.97578006e-01,-8.03259847e-02, 7.10738498e-01, 4.22244762e-02],
                         [ 6.97559896e-01,-8.03616568e-02, 7.10748067e-01, 4.22963990e-02],
                         [ 6.97538803e-01,-8.03948269e-02, 7.10759590e-01, 4.23930696e-02],
                         [ 6.97513550e-01,-8.04218164e-02, 7.10773788e-01, 4.25093521e-02],
                         [ 6.97488597e-01,-8.04439650e-02, 7.10788204e-01, 4.26340263e-02],
                         [ 6.97470596e-01,-8.04660328e-02, 7.10796154e-01, 4.27601959e-02],
                         [ 6.97464592e-01,-8.04929766e-02, 7.10792635e-01, 4.28709297e-02],
                         [ 6.97472429e-01,-8.05272842e-02, 7.10776287e-01, 4.29529613e-02],
                         [ 6.97488276e-01,-8.05650922e-02, 7.10752939e-01, 4.30071738e-02],
                         [ 6.97521569e-01,-8.06010173e-02, 7.10714794e-01, 4.30341897e-02],
                         [ 6.97570659e-01,-8.06363919e-02, 7.10661586e-01, 4.30514715e-02],
                         [ 6.97619590e-01,-8.06863771e-02, 7.10607074e-01, 4.30572186e-02],
                         [ 6.97677617e-01,-8.07461249e-02, 7.10544139e-01, 4.30460171e-02],
                         [ 6.97730798e-01,-8.08093951e-02, 7.10485804e-01, 4.30220023e-02],
                         [ 6.97763294e-01,-8.08700177e-02, 7.10447848e-01, 4.30090000e-02],
                         [ 6.97774000e-01,-8.09263063e-02, 7.10430385e-01, 4.30147690e-02],
                         [ 6.97771672e-01,-8.09715359e-02, 7.10425836e-01, 4.30358795e-02],
                         [ 6.97768826e-01,-8.10040289e-02, 7.10423239e-01, 4.30703138e-02],
                         [ 6.97765038e-01,-8.10272548e-02, 7.10422000e-01, 4.31138408e-02],
                         [ 6.97754037e-01,-8.10433652e-02, 7.10429170e-01, 4.31509253e-02],
                         [ 6.97737755e-01,-8.10381521e-02, 7.10444245e-01, 4.31738480e-02],
                         [ 6.97726138e-01,-8.10024326e-02, 7.10457686e-01, 4.32101753e-02],
                         [ 6.97719322e-01,-8.09613201e-02, 7.10466904e-01, 4.32522929e-02],
                         [ 6.97719473e-01,-8.09167119e-02, 7.10470000e-01, 4.32805987e-02],
                         [ 6.97730973e-01,-8.08655896e-02, 7.10463144e-01, 4.32971026e-02],
                         [ 6.97749569e-01,-8.07994962e-02, 7.10451459e-01, 4.33126834e-02],
                         [ 6.97776642e-01,-8.07295499e-02, 7.10432428e-01, 4.33196336e-02],
                         [ 6.97798859e-01,-8.06698695e-02, 7.10417613e-01, 4.33116964e-02],
                         [ 6.97803712e-01,-8.06190933e-02, 7.10419151e-01, 4.33024928e-02],
                         [ 6.97801702e-01,-8.05721440e-02, 7.10426543e-01, 4.32974038e-02],
                         [ 6.97787262e-01,-8.05429161e-02, 7.10445355e-01, 4.32802993e-02],
                         [ 6.97760220e-01,-8.05406155e-02, 7.10473781e-01, 4.32535382e-02],
                         [ 6.97730730e-01,-8.05675867e-02, 7.10501942e-01, 4.32214069e-02],
                         [ 6.97709616e-01,-8.06128133e-02, 7.10519036e-01, 4.31986158e-02],
                         [ 6.97681732e-01,-8.06661147e-02, 7.10540545e-01, 4.31903008e-02],
                         [ 6.97646522e-01,-8.07261579e-02, 7.10568039e-01, 4.31876401e-02],
                         [ 6.97609651e-01,-8.08001244e-02, 7.10596184e-01, 4.31835744e-02],
                         [ 6.97573841e-01,-8.08788412e-02, 7.10622257e-01, 4.31833806e-02],
                         [ 6.97533097e-01,-8.09607203e-02, 7.10653645e-01, 4.31777412e-02],
                         [ 6.97482870e-01,-8.10371423e-02, 7.10694826e-01, 4.31693954e-02],
                         [ 6.97439477e-01,-8.11041669e-02, 7.10729878e-01, 4.31662943e-02],
                         [ 6.97407384e-01,-8.11421939e-02, 7.10756772e-01, 4.31631565e-02],
                         [ 6.97379667e-01,-8.11729132e-02, 7.10781185e-01, 4.31577038e-02],
                         [ 6.97351086e-01,-8.11899331e-02, 7.10808194e-01, 4.31466245e-02],
                         [ 6.97333558e-01,-8.11922737e-02, 7.10826169e-01, 4.31175779e-02],
                         [ 6.97327074e-01,-8.11817590e-02, 7.10836584e-01, 4.30867866e-02],
                         [ 6.97312740e-01,-8.11573738e-02, 7.10855207e-01, 4.30495339e-02],
                         [ 6.97299099e-01,-8.11099426e-02, 7.10875836e-01, 4.30219385e-02],
                         [ 6.97281808e-01,-8.10556643e-02, 7.10899674e-01, 4.30085304e-02],
                         [ 6.97246916e-01,-8.10074029e-02, 7.10939845e-01, 4.30022395e-02],
                         [ 6.97209739e-01,-8.09551077e-02, 7.10982048e-01, 4.30040291e-02],
                         [ 6.97181940e-01,-8.09076912e-02, 7.11014110e-01, 4.30103369e-02],
                         [ 6.97162951e-01,-8.08716701e-02, 7.11037887e-01, 4.29966486e-02],
                         [ 6.97155136e-01,-8.08500910e-02, 7.11049182e-01, 4.29672728e-02],
                         [ 6.97166446e-01,-8.08249973e-02, 7.11043999e-01, 4.29265512e-02],
                         [ 6.97209935e-01,-8.07955091e-02, 7.11009113e-01, 4.28567066e-02],
                         [ 6.97251740e-01,-8.07834828e-02, 7.10974779e-01, 4.27682751e-02],
                         [ 6.97292528e-01,-8.07724801e-02, 7.10943408e-01, 4.26490394e-02],
                         [ 6.97332142e-01,-8.07492393e-02, 7.10914643e-01, 4.25263825e-02],
                         [ 6.97364110e-01,-8.07166762e-02, 7.10894536e-01, 4.23951152e-02],
                         [ 6.97387795e-01,-8.06816922e-02, 7.10883722e-01, 4.22549594e-02],
                         [ 6.97411536e-01,-8.06375583e-02, 7.10873048e-01, 4.21246281e-02],
                         [ 6.97421735e-01,-8.05905021e-02, 7.10875915e-01, 4.20043456e-02],
                         [ 6.97420528e-01,-8.05399629e-02, 7.10888540e-01, 4.19005741e-02],
                         [ 6.97410047e-01,-8.04986530e-02, 7.10908418e-01, 4.18166470e-02],
                         [ 6.97390474e-01,-8.04703013e-02, 7.10934534e-01, 4.17454150e-02],
                         [ 6.97365167e-01,-8.04483659e-02, 7.10964192e-01, 4.17037701e-02],
                         [ 6.97349172e-01,-8.04357064e-02, 7.10983363e-01, 4.16785679e-02],
                         [ 6.97333400e-01,-8.04374001e-02, 7.10999600e-01, 4.16656497e-02],
                         [ 6.97340407e-01,-8.04508277e-02, 7.10990883e-01, 4.16648552e-02],
                         [ 6.97352324e-01,-8.04822513e-02, 7.10976095e-01, 4.16606983e-02],
                         [ 6.97369579e-01,-8.05077717e-02, 7.10954959e-01, 4.16807717e-02],
                         [ 6.97389413e-01,-8.05292834e-02, 7.10931975e-01, 4.16961890e-02],
                         [ 6.97393752e-01,-8.05398821e-02, 7.10925497e-01, 4.17198948e-02],
                         [ 6.97386072e-01,-8.05691903e-02, 7.10927643e-01, 4.17511903e-02],
                         [ 6.97360189e-01,-8.05916081e-02, 7.10947494e-01, 4.17948745e-02],
                         [ 6.97327589e-01,-8.06029125e-02, 7.10976738e-01, 4.18329764e-02],
                         [ 6.97283662e-01,-8.06246174e-02, 7.11014960e-01, 4.18674778e-02],
                         [ 6.97239332e-01,-8.06531453e-02, 7.11054161e-01, 4.18944406e-02],
                         [ 6.97197825e-01,-8.06804813e-02, 7.11089735e-01, 4.19169477e-02],
                         [ 6.97144759e-01,-8.07112679e-02, 7.11136770e-01, 4.19390611e-02],
                         [ 6.97084979e-01,-8.07571000e-02, 7.11190519e-01, 4.19455851e-02],
                         [ 6.97000693e-01,-8.07978870e-02, 7.11267852e-01, 4.19478444e-02]])

        # we took data from IMU for 1 seconds(200 sequence and then preprocess)
        gyro_uncalib = imu_sequence[:, :3]
        acce_uncalib = imu_sequence[:, 3:6]
        gyro_bias = 0
        acce_bias = 0
        gyro = gyro_uncalib - gyro_bias
        acce = acce_uncalib - acce_bias     # acce = np.array(self.info['imu_acce_scale']) * (acce_uncalib - np.array(self.info['imu_acce_bias']))
        ts = imu_sequence[:, 6]

        init_tango_ori = quaternion.quaternion(0.485343539639586, 0.504241771588516, 0.468878391832952, -0.53882725796654)

        # Compute the IMU orientation in the Tango coordinate frame.
        ori_q = quaternion.from_float_array(ori)
        rot_imu_to_tango = quaternion.quaternion(0.0, 0.99988972, 0.09068246, 0.0)
        init_rotor = init_tango_ori * rot_imu_to_tango * ori_q[0].conj()
        ori_q = init_rotor * ori_q

        gyro_q = quaternion.from_float_array(np.concatenate([np.zeros([gyro.shape[0], 1]), gyro], axis=1))
        acce_q = quaternion.from_float_array(np.concatenate([np.zeros([acce.shape[0], 1]), acce], axis=1))
        glob_gyro = quaternion.as_float_array(ori_q * gyro_q * ori_q.conj())[:, 1:]
        glob_acce = quaternion.as_float_array(ori_q * acce_q * ori_q.conj())[:, 1:]

        self.ts = ts
        self.features = np.concatenate([glob_gyro, glob_acce], axis=1)
        self.orientations = quaternion.as_float_array(ori_q)


    def get_feature(self):
        return self.features

    def get_target(self):
        return self.targets

    def get_aux(self):
        return np.concatenate([self.ts[:, None], self.orientations], axis=1)

    def get_meta(self):
        return '{}: device: {}, ori_error ({}): {:.3f}'.format(
            self.info['path'], self.info['device'], self.info['ori_source'], self.info['source_ori_error'])


class StridedSequenceDataset(Dataset):
    def __init__(self, imu_sequence, seq_type, step_size=10, window_size=200,
                 random_shift=0, transform=None, **kwargs):
        super(StridedSequenceDataset, self).__init__()
        self.feature_dim = seq_type.feature_dim
        self.target_dim = seq_type.target_dim
        self.aux_dim = seq_type.aux_dim
        self.window_size = window_size
        self.step_size = step_size
        self.random_shift = random_shift
        self.transform = transform
        self.interval = kwargs.get('interval', window_size)

        self.index_map = []
        self.ts, self.orientations, self.gt_pos = [], [], []
        self.features, self.targets, aux = load_cached_sequences(
            seq_type, imu_sequence, interval=self.interval, **kwargs)
        self.ts = aux[0][:, 0]
        self.orientations = (aux[0][:, 1:5])


    def __getitem__(self, item):

        feat = numpy.array(self.features[0])
        ts = numpy.array(self.ts)
        orientations = numpy.array(self.orientations)

        return feat.astype(np.float32).T, ts, orientations

    def __len__(self):
        return len(self.features)

